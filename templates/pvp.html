{% extends "layout.html" %}
{% block title %}PVP Mode{% endblock %}
{% block content %}
    <div class="container mt-5 mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">PVP对战模式</h2>
                            <button id="quitBtn" class="btn btn-light btn-sm">退出</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- 匹配设置区域 -->
                        <div class="p-4 border-bottom" id="matchSetup">
                            <h5 class="text-muted mb-3">匹配设置</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="pvpDifficulty" class="form-label text-muted">难度选择</label>
                                    <select id="pvpDifficulty" class="form-select border-primary">
                                        <option value="beginner">入门模式 (easy:0.9, mid-easy:0.1, mid:0)</option>
                                        <option value="easy" selected>简单模式 (easy:0.5, mid-easy:0.5, mid:0)</option>
                                        <option value="advanced">进阶模式 (easy:0.2, mid-easy:0.8, mid:0)</option>
                                        <option value="medium">中等模式 (easy:0.1, mid-easy:0.8, mid:0.1)</option>
                                        <option value="hard">困难模式 (easy:0, mid-easy:0.3, mid:0.7)</option>
                                    </select>
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <button id="startMatchBtn" class="btn btn-primary w-100">开始匹配</button>
                                </div>
                            </div>
                        </div>

                        <!-- 匹配等待区域 -->
                        <div class="p-4 text-center" id="matchWaiting" style="display: none;">
                            <div class="mb-4">
                                <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
                                    <span class="visually-hidden">匹配中...</span>
                                </div>
                            </div>
                            <h3 class="text-primary mb-2">正在匹配对手</h3>
                            <p class="text-muted mb-4">系统正在为您匹配旗鼓相当的对手...</p>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="mt-3">
                                <button id="cancelMatchBtn" class="btn btn-secondary">取消匹配</button>
                            </div>
                        </div>

                        <!-- 游戏对战区域 -->
                        <div id="gameBattle" style="display: none;">
                            <!-- 游戏状态 -->
                            <div class="p-4 border-bottom bg-light">
                                <div class="row g-3">
                                    <div class="col-md-4 text-center">
                                        <h6 class="text-muted">游戏轮数</h6>
                                        <p id="pvpRound" class="display-6 text-primary mb-0">1</p>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <h6 class="text-muted">倒计时</h6>
                                        <p id="pvpTimer" class="display-6 text-primary mb-0">-</p>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <h6 class="text-muted">匹配状态</h6>
                                        <p id="pvpStatus" class="display-6 text-primary mb-0">进行中</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 玩家信息 -->
                            <div class="p-4 border-bottom">
                                <div class="row g-3">
                                    <!-- 对手信息 -->
                                    <div class="col-md-6">
                                        <div class="card bg-light border-primary">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="text-muted">对手</h6>
                                                    <span id="opponentUsername" class="text-primary fw-bold">-</span>
                                                </div>
                                                <div class="mb-2">
                                                    <div class="d-flex justify-content-between text-sm mb-1">
                                                        <span class="text-muted">血量</span>
                                                        <span id="opponentHp" class="fw-bold">100</span>
                                                    </div>
                                                    <div class="progress" style="height: 10px;">
                                                        <div id="opponentHpBar" class="progress-bar bg-primary" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                </div>
                                                <div class="mb-2">
                                                    <div class="d-flex justify-content-between text-sm mb-1">
                                                        <span class="text-muted">ELO分数</span>
                                                        <span id="opponentElo" class="fw-bold">1000</span>
                                                    </div>
                                                </div>
                                                <div id="opponentStatus" class="text-center">
                                                    <span class="badge bg-info">思考中...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 自己信息 -->
                                    <div class="col-md-6">
                                        <div class="card bg-light border-primary">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="text-muted">自己</h6>
                                                    <span id="myUsername" class="text-primary fw-bold">{{ current_user.username }}</span>
                                                </div>
                                                <div class="mb-2">
                                                    <div class="d-flex justify-content-between text-sm mb-1">
                                                        <span class="text-muted">血量</span>
                                                        <span id="myHp" class="fw-bold">100</span>
                                                    </div>
                                                    <div class="progress" style="height: 10px;">
                                                        <div id="myHpBar" class="progress-bar bg-primary" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                </div>
                                                <div class="mb-2">
                                                    <div class="d-flex justify-content-between text-sm mb-1">
                                                        <span class="text-muted">ELO分数</span>
                                                        <span id="myElo" class="fw-bold">{{ current_user.elo_score }}</span>
                                                    </div>
                                                </div>
                                                <div id="myStatus" class="text-center">
                                                    <span class="badge bg-success">准备就绪</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 对话历史 -->
                            <div class="p-4" style="height: 300px; overflow-y: auto;" id="pvpConversation">
                                <div class="text-center text-muted py-5">
                                    <i class="bi bi-chat-dots display-4 mb-3"></i>
                                    <p>等待对手准备就绪...</p>
                                </div>
                            </div>

                            <!-- 输入区域 -->
                            <div class="p-4 border-top">
                                <div class="input-group">
                                    <input type="text" id="pvpQuestionInput" class="form-control border-primary" placeholder="输入您的问题或直接猜测物质名称..." aria-label="输入您的问题或直接猜测物质名称...">
                                    <button class="btn btn-primary" type="button" id="pvpSubmitBtn">发送</button>
                                    <button class="btn btn-warning" type="button" id="pvpLockBtn">锁定答案</button>
                                </div>
                                <div class="text-sm text-muted mt-2">
                                    <p>示例：</p>
                                    <ul class="list-unstyled d-flex flex-wrap gap-2">
                                        <li class="bg-light px-2 py-1 rounded">该物质是否是氧化物？</li>
                                        <li class="bg-light px-2 py-1 rounded">该物质是否含有金属元素？</li>
                                        <li class="bg-light px-2 py-1 rounded">氯化钠</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- 游戏结束区域 -->
                        <div class="p-4 text-center" id="gameEnd" style="display: none;">
                            <i id="pvpResultIcon" class="bi bi-check-circle display-4 text-primary mb-3"></i>
                            <h3 id="pvpResultTitle" class="mb-3"></h3>
                            <p id="pvpResultMessage" class="text-muted mb-4"></p>
                            <div class="row g-3 justify-content-center mb-4">
                                <div class="col-6">
                                    <div class="card bg-light border-primary">
                                        <div class="card-body">
                                            <h6 class="text-muted">您的最终血量</h6>
                                            <p id="pvpFinalMyHp" class="display-6 text-primary mb-0"></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card bg-light border-primary">
                                        <div class="card-body">
                                            <h6 class="text-muted">对手最终血量</h6>
                                            <p id="pvpFinalOpponentHp" class="display-6 text-primary mb-0"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3 justify-content-center">
                                <div class="col-6">
                                    <div class="card bg-light border-primary">
                                        <div class="card-body">
                                            <h6 class="text-muted">ELO变化</h6>
                                            <p id="pvpEloChange" class="display-6 text-primary mb-0"></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card bg-light border-primary">
                                        <div class="card-body">
                                            <h6 class="text-muted">游戏时长</h6>
                                            <p id="pvpGameDuration" class="display-6 text-primary mb-0"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-5">
                                <button id="pvpPlayAgainBtn" class="btn btn-primary btn-lg me-2">再玩一次</button>
                                <button id="pvpReturnHomeBtn" class="btn btn-secondary btn-lg">返回主页</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 游戏状态
        let pvpGameState = {
            isMatching: false,
            isPlaying: false,
            difficulty: '',
            round: 1,
            myHp: 100,
            opponentHp: 100,
            myGuessCount: 0,
            opponentGuessCount: 0,
            myAnswerLocked: false,
            opponentAnswerLocked: false,
            timer: null
        };

        // WebSocket连接
        let ws = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 绑定事件
            document.getElementById('startMatchBtn').addEventListener('click', startMatch);
            document.getElementById('cancelMatchBtn').addEventListener('click', cancelMatch);
            document.getElementById('quitBtn').addEventListener('click', quitGame);
            document.getElementById('pvpSubmitBtn').addEventListener('click', submitPvpQuestion);
            document.getElementById('pvpQuestionInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitPvpQuestion();
                }
            });
            document.getElementById('pvpLockBtn').addEventListener('click', lockPvpAnswer);
            document.getElementById('pvpPlayAgainBtn').addEventListener('click', startMatch);
            document.getElementById('pvpReturnHomeBtn').addEventListener('click', function() {
                window.location.href = '/';
            });
        });

        // 开始匹配
        function startMatch() {
            // 隐藏其他区域，显示匹配等待
            document.getElementById('matchSetup').style.display = 'none';
            document.getElementById('matchWaiting').style.display = 'block';
            document.getElementById('gameBattle').style.display = 'none';
            document.getElementById('gameEnd').style.display = 'none';

            // 获取难度选择
            const difficultySelect = document.getElementById('pvpDifficulty');
            const difficulty = difficultySelect.value;
            pvpGameState.difficulty = difficulty;
            pvpGameState.isMatching = true;

            // 更新匹配状态
            updateMatchProgress();

            // 连接WebSocket
            connectWebSocket();

            // 模拟匹配过程（实际项目中应该调用后端API）
            setTimeout(() => {
                startBattle();
            }, 3000);
        }

        // 取消匹配
        function cancelMatch() {
            pvpGameState.isMatching = false;
            // 隐藏匹配等待，显示匹配设置
            document.getElementById('matchSetup').style.display = 'block';
            document.getElementById('matchWaiting').style.display = 'none';
            // 关闭WebSocket连接
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // 退出游戏
        function quitGame() {
            if (confirm('确定要退出PVP对战吗？')) {
                window.location.href = '/';
            }
        }

        // 连接WebSocket
        function connectWebSocket() {
            // 实际项目中应该连接到后端WebSocket服务器
            // 这里只是模拟
            console.log('连接WebSocket...');
        }

        // 更新匹配进度
        function updateMatchProgress() {
            const progressBar = document.querySelector('#matchWaiting .progress-bar');
            let progress = 0;
            const interval = setInterval(() => {
                if (!pvpGameState.isMatching) {
                    clearInterval(interval);
                    return;
                }
                progress += 10;
                progressBar.style.width = `${progress}%`;
                if (progress >= 100) {
                    clearInterval(interval);
                }
            }, 300);
        }

        // 开始对战
        function startBattle() {
            pvpGameState.isMatching = false;
            pvpGameState.isPlaying = true;
            pvpGameState.round = 1;
            pvpGameState.myHp = 100;
            pvpGameState.opponentHp = 100;
            pvpGameState.myGuessCount = 0;
            pvpGameState.opponentGuessCount = 0;
            pvpGameState.myAnswerLocked = false;
            pvpGameState.opponentAnswerLocked = false;

            // 隐藏匹配等待，显示游戏对战
            document.getElementById('matchWaiting').style.display = 'none';
            document.getElementById('gameBattle').style.display = 'block';

            // 更新游戏状态
            document.getElementById('pvpRound').textContent = pvpGameState.round;
            document.getElementById('myHp').textContent = pvpGameState.myHp;
            document.getElementById('myHpBar').style.width = '100%';
            document.getElementById('opponentHp').textContent = pvpGameState.opponentHp;
            document.getElementById('opponentHpBar').style.width = '100%';

            // 添加初始消息
            addPvpMessage('system', '游戏开始！双方各有100点初始血量');

            // 聚焦输入框
            document.getElementById('pvpQuestionInput').focus();
        }

        // 提交问题/猜测
        function submitPvpQuestion() {
            if (!pvpGameState.isPlaying || pvpGameState.myAnswerLocked) return;

            const questionInput = document.getElementById('pvpQuestionInput');
            const question = questionInput.value.trim();

            if (!question) {
                return;
            }

            // 更新猜测次数
            pvpGameState.myGuessCount++;

            // 添加到对话历史
            addPvpMessage('me', question);

            // 清空输入框
            questionInput.value = '';

            // 模拟AI回答
            setTimeout(() => {
                // 随机生成回答
                const answers = ['YES', 'NO', 'CANNOT ANSWER'];
                const answer = answers[Math.floor(Math.random() * answers.length)];
                addPvpMessage('ai', answer);
            }, 1000);
        }

        // 锁定答案
        function lockPvpAnswer() {
            if (!pvpGameState.isPlaying || pvpGameState.myAnswerLocked) return;

            pvpGameState.myAnswerLocked = true;

            // 更新状态
            document.getElementById('myStatus').innerHTML = '<span class="badge bg-warning">答案已锁定</span>';
            document.getElementById('pvpSubmitBtn').disabled = true;
            document.getElementById('pvpLockBtn').disabled = true;

            // 添加到对话历史
            addPvpMessage('system', '您已锁定答案，等待对手锁定...');

            // 启动倒计时
            startCountdown();

            // 模拟对手也锁定答案
            setTimeout(() => {
                pvpGameState.opponentAnswerLocked = true;
                document.getElementById('opponentStatus').innerHTML = '<span class="badge bg-warning">答案已锁定</span>';
                addPvpMessage('system', '对手已锁定答案，正在结算...');
                // 结算本轮
                setTimeout(() => {
                    endRound();
                }, 2000);
            }, 5000);
        }

        // 启动倒计时
        function startCountdown() {
            const confirmTimeLimit = 15; // 从.env获取
            let timeLeft = confirmTimeLimit;
            document.getElementById('pvpTimer').textContent = timeLeft;

            if (pvpGameState.timer) {
                clearInterval(pvpGameState.timer);
            }

            pvpGameState.timer = setInterval(() => {
                timeLeft--;
                document.getElementById('pvpTimer').textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(pvpGameState.timer);
                    pvpGameState.timer = null;
                    // 对手超时，结算本轮
                    endRound();
                }
            }, 1000);
        }

        // 结束本轮
        function endRound() {
            // 清除倒计时
            if (pvpGameState.timer) {
                clearInterval(pvpGameState.timer);
                pvpGameState.timer = null;
            }

            // 重置锁定状态
            pvpGameState.myAnswerLocked = false;
            pvpGameState.opponentAnswerLocked = false;

            // 更新状态
            document.getElementById('myStatus').innerHTML = '<span class="badge bg-success">准备就绪</span>';
            document.getElementById('opponentStatus').innerHTML = '<span class="badge bg-info">思考中...</span>';
            document.getElementById('pvpSubmitBtn').disabled = false;
            document.getElementById('pvpLockBtn').disabled = false;
            document.getElementById('pvpTimer').textContent = '-';

            // 模拟伤害计算
            const baseDamage = 100; // 从.env获取
            const damageScale = 0.25; // 从.env获取
            const myDamage = Math.floor((damageScale * (pvpGameState.round - 1) + 1) * baseDamage / (pvpGameState.myGuessCount || 1));
            const opponentDamage = Math.floor((damageScale * (pvpGameState.round - 1) + 1) * baseDamage / (pvpGameState.opponentGuessCount || 1));

            // 更新血量
            pvpGameState.myHp = Math.max(0, pvpGameState.myHp - opponentDamage);
            pvpGameState.opponentHp = Math.max(0, pvpGameState.opponentHp - myDamage);

            // 更新UI
            document.getElementById('myHp').textContent = pvpGameState.myHp;
            document.getElementById('myHpBar').style.width = `${pvpGameState.myHp}%`;
            document.getElementById('opponentHp').textContent = pvpGameState.opponentHp;
            document.getElementById('opponentHpBar').style.width = `${pvpGameState.opponentHp}%`;

            // 添加到对话历史
            addPvpMessage('system', `第 ${pvpGameState.round} 轮结束！`);
            addPvpMessage('system', `您受到 ${opponentDamage} 点伤害，剩余血量: ${pvpGameState.myHp}`);
            addPvpMessage('system', `对手受到 ${myDamage} 点伤害，剩余血量: ${pvpGameState.opponentHp}`);

            // 检查游戏是否结束
            if (pvpGameState.myHp <= 0 || pvpGameState.opponentHp <= 0) {
                endPvpGame();
            } else {
                // 进入下一轮
                pvpGameState.round++;
                document.getElementById('pvpRound').textContent = pvpGameState.round;
                pvpGameState.myGuessCount = 0;
                pvpGameState.opponentGuessCount = 0;
                addPvpMessage('system', `第 ${pvpGameState.round} 轮开始！`);
            }
        }

        // 结束游戏
        function endPvpGame() {
            pvpGameState.isPlaying = false;

            // 隐藏游戏对战，显示游戏结束
            document.getElementById('gameBattle').style.display = 'none';
            document.getElementById('gameEnd').style.display = 'block';

            // 确定结果
            let result = '';
            if (pvpGameState.myHp > 0 && pvpGameState.opponentHp <= 0) {
                result = 'win';
            } else if (pvpGameState.myHp <= 0 && pvpGameState.opponentHp > 0) {
                result = 'lose';
            } else {
                result = 'draw';
            }

            // 更新游戏结束界面
            const resultIcon = document.getElementById('pvpResultIcon');
            const resultTitle = document.getElementById('pvpResultTitle');
            const resultMessage = document.getElementById('pvpResultMessage');

            if (result === 'win') {
                resultIcon.className = 'bi bi-check-circle display-4 text-primary mb-3';
                resultTitle.textContent = '恭喜你！';
                resultMessage.textContent = '你赢得了这场对战！';
            } else if (result === 'lose') {
                resultIcon.className = 'bi bi-x-circle display-4 text-danger mb-3';
                resultTitle.textContent = '很遗憾！';
                resultMessage.textContent = '你输掉了这场对战！';
            } else {
                resultIcon.className = 'bi bi-info-circle display-4 text-warning mb-3';
                resultTitle.textContent = '平局！';
                resultMessage.textContent = '这场对战以平局结束！';
            }

            // 更新最终数据
            document.getElementById('pvpFinalMyHp').textContent = pvpGameState.myHp;
            document.getElementById('pvpFinalOpponentHp').textContent = pvpGameState.opponentHp;
            document.getElementById('pvpEloChange').textContent = result === 'win' ? '+20' : result === 'lose' ? '-20' : '0';
            document.getElementById('pvpGameDuration').textContent = '5分钟'; // 模拟时长

            // 关闭WebSocket连接
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // 添加消息到PVP对话历史
        function addPvpMessage(sender, content) {
            const conversationHistory = document.getElementById('pvpConversation');
            const messageDiv = document.createElement('div');
            let messageContent = '';

            if (sender === 'me') {
                messageDiv.className = 'p-3 mb-2 bg-primary bg-opacity-10 rounded';
                messageContent = `
                    <div class="d-flex justify-content-end">
                        <div class="max-w-75 p-3 rounded bg-primary text-white">
                            ${content}
                        </div>
                    </div>
                `;
            } else if (sender === 'opponent') {
                messageDiv.className = 'p-3 mb-2 bg-light rounded';
                messageContent = `
                    <div class="d-flex justify-content-start">
                        <div class="max-w-75 p-3 rounded bg-white border border-primary text-dark">
                            ${content}
                        </div>
                    </div>
                `;
            } else if (sender === 'ai') {
                messageDiv.className = 'p-3 mb-2 bg-info bg-opacity-10 rounded';
                messageContent = `
                    <div class="d-flex justify-content-center">
                        <div class="max-w-75 p-3 rounded bg-info text-white">
                            ${content}
                        </div>
                    </div>
                `;
            } else if (sender === 'system') {
                messageDiv.className = 'p-3 mb-2 bg-light rounded';
                messageContent = `
                    <div class="d-flex justify-content-center">
                        <div class="max-w-75 p-3 rounded bg-white border border-secondary text-muted">
                            ${content}
                        </div>
                    </div>
                `;
            }

            messageDiv.innerHTML = messageContent;
            conversationHistory.appendChild(messageDiv);
            
            // 滚动到底部
            conversationHistory.scrollTop = conversationHistory.scrollHeight;
        }

        // 取消匹配
        function cancelMatch() {
            pvpGameState.isMatching = false;
            // 隐藏匹配等待，显示匹配设置
            document.getElementById('matchSetup').style.display = 'block';
            document.getElementById('matchWaiting').style.display = 'none';
            // 关闭WebSocket连接
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // 连接WebSocket
        function connectWebSocket() {
            // 实际项目中应该连接到后端WebSocket服务器
            // ws = new WebSocket('ws://localhost:2300/ws/pvp');
            // ws.onopen = function() {
            //     console.log('WebSocket连接已建立');
            // };
            // ws.onmessage = function(event) {
            //     const data = JSON.parse(event.data);
            //     handleWebSocketMessage(data);
            // };
            // ws.onerror = function(error) {
            //     console.error('WebSocket错误:', error);
            // };
            // ws.onclose = function() {
            //     console.log('WebSocket连接已关闭');
            // };
        }
    </script>
{% endblock %}