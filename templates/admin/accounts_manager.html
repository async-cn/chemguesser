{% extends "layout.html" %}
{% block title %}账户管理 - ChemGuesser{% endblock %}
{% block content %}
    <div class="container mt-5 mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">账户管理</h2>
                            <div class="d-flex gap-2">
                                <button id="refreshBtn" class="btn btn-light btn-sm">刷新列表</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <!-- 账户列表 -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col">用户名</th>
                                        <th scope="col">邮箱</th>
                                        <th scope="col">ELO分数</th>
                                        <th scope="col">创建时间</th>
                                        <th scope="col">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="accountsTableBody">
                                    <!-- 账户数据将通过JavaScript动态加载 -->
                                    <tr>
                                        <td colspan="6" class="text-center py-5">
                                            <i class="bi bi-hourglass-split display-4 mb-3 text-muted"></i>
                                            <p class="text-muted">正在加载账户列表...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 分页控件 -->
                        <div class="mt-4" id="paginationControls" style="display: none;">
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" id="prevPageItem">
                                        <a class="page-link" href="#" tabindex="-1" id="prevPageBtn">上一页</a>
                                    </li>
                                    <!-- 页码按钮将通过JavaScript动态生成 -->
                                    <li class="page-item" id="nextPageItem">
                                        <a class="page-link" href="#" id="nextPageBtn">下一页</a>
                                    </li>
                                </ul>
                            </nav>
                            <div class="text-center mt-2">
                                <small class="text-muted">
                                    第 <span id="currentPage">1</span> 页，共 <span id="totalPages">1</span> 页，
                                    总计 <span id="totalUsers">0</span> 个账户
                                </small>
                            </div>
                            <!-- 快速跳转 -->
                            <div class="text-center mt-2">
                                <small class="text-muted">跳转到</small>
                                <input type="number" id="jumpToPage" class="form-control form-control-sm d-inline-block w-25 mx-2" min="1" value="1">
                                <button id="jumpBtn" class="btn btn-sm btn-primary">跳转</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">删除确认</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确定要删除用户 <strong id="deleteUsername">用户名</strong> 吗？</p>
                    <p class="text-danger small">此操作不可撤销，删除后用户数据将永久丢失。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">删除</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化变量
            let currentPage = 1;
            let perPage = 30;
            let totalPages = 1;
            let totalUsers = 0;
            let deleteUserId = null;
            
            // 获取DOM元素
            const accountsTableBody = document.getElementById('accountsTableBody');
            const paginationControls = document.getElementById('paginationControls');
            const prevPageItem = document.getElementById('prevPageItem');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageItem = document.getElementById('nextPageItem');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const currentPageSpan = document.getElementById('currentPage');
            const totalPagesSpan = document.getElementById('totalPages');
            const totalUsersSpan = document.getElementById('totalUsers');
            const jumpToPageInput = document.getElementById('jumpToPage');
            const jumpBtn = document.getElementById('jumpBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            const deleteUsernameSpan = document.getElementById('deleteUsername');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            
            // 加载账户列表
            function loadAccounts(page = 1, perPage = 30) {
                // 保存当前页码
                currentPage = page;
                
                // 清空表格内容，显示加载中
                accountsTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="bi bi-hourglass-split display-4 mb-3 text-muted"></i>
                            <p class="text-muted">正在加载账户列表...</p>
                        </td>
                    </tr>
                `;
                
                // 隐藏分页控件
                paginationControls.style.display = 'none';
                
                // 发送请求
                fetch(`/admin/accounts?page=${page}&per_page=${perPage}`)
                    .then(response => {
                        return response.json().then(data => {
                            return { status: response.status, data: data };
                        });
                    })
                    .then(({ status, data }) => {
                        // 处理响应
                        if (status === 200 && data.status === 'success') {
                            // 更新表格内容
                            updateAccountsTable(data.data.users);
                            
                            // 更新分页信息
                            updatePagination(data.data.pagination);
                        } else {
                            // 显示错误信息
                            showError(data.message || '加载账户列表失败');
                        }
                    })
                    .catch(error => {
                        // 显示网络错误
                        showError('网络请求失败，请稍后重试');
                        console.error('加载账户列表失败:', error);
                    });
            }
            
            // 更新账户表格
            function updateAccountsTable(users) {
                if (users.length === 0) {
                    accountsTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <i class="bi bi-info-circle display-4 mb-3 text-muted"></i>
                                <p class="text-muted">暂无账户数据</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // 生成表格行
                const rows = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>${user.elo_score}</td>
                        <td>${new Date(user.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-danger btn-sm delete-btn" data-user-id="${user.id}" data-username="${user.username}">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                accountsTableBody.innerHTML = rows;
                
                // 绑定删除按钮事件
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', handleDeleteClick);
                });
            }
            
            // 更新分页控件
            function updatePagination(pagination) {
                // 更新变量
                currentPage = pagination.page;
                perPage = pagination.per_page;
                totalPages = pagination.pages;
                totalUsers = pagination.total;
                
                // 更新DOM
                currentPageSpan.textContent = currentPage;
                totalPagesSpan.textContent = totalPages;
                totalUsersSpan.textContent = totalUsers;
                jumpToPageInput.value = currentPage;
                jumpToPageInput.max = totalPages;
                
                // 显示分页控件
                paginationControls.style.display = 'block';
                
                // 更新上一页/下一页按钮状态
                prevPageItem.classList.toggle('disabled', !pagination.has_prev);
                nextPageItem.classList.toggle('disabled', !pagination.has_next);
            }
            
            // 处理删除按钮点击
            function handleDeleteClick(e) {
                const userId = e.target.closest('.delete-btn').dataset.userId;
                const username = e.target.closest('.delete-btn').dataset.username;
                
                // 保存要删除的用户ID
                deleteUserId = userId;
                deleteUsernameSpan.textContent = username;
                
                // 显示删除确认模态框
                deleteConfirmModal.show();
            }
            
            // 处理确认删除
            function handleConfirmDelete() {
                if (!deleteUserId) return;
                
                // 发送删除请求
                fetch(`/admin/accounts/${deleteUserId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    return response.json().then(data => {
                        return { status: response.status, data: data };
                    });
                })
                .then(({ status, data }) => {
                    // 关闭模态框
                    deleteConfirmModal.hide();
                    
                    if (status === 200 && data.status === 'success') {
                        // 显示成功消息
                        alert('账户删除成功');
                        
                        // 重新加载当前页
                        loadAccounts(currentPage, perPage);
                    } else {
                        // 显示错误消息
                        showError(data.message || '删除账户失败');
                    }
                })
                .catch(error => {
                    // 关闭模态框
                    deleteConfirmModal.hide();
                    
                    // 显示网络错误
                    showError('网络请求失败，请稍后重试');
                    console.error('删除账户失败:', error);
                });
            }
            
            // 显示错误信息
            function showError(message) {
                alert(message);
                
                // 更新表格内容
                accountsTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="bi bi-exclamation-triangle display-4 mb-3 text-danger"></i>
                            <p class="text-danger">${message}</p>
                        </td>
                    </tr>
                `;
            }
            
            // 绑定事件
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    loadAccounts(currentPage - 1, perPage);
                }
            });
            
            nextPageBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    loadAccounts(currentPage + 1, perPage);
                }
            });
            
            jumpBtn.addEventListener('click', () => {
                const jumpPage = parseInt(jumpToPageInput.value);
                if (jumpPage >= 1 && jumpPage <= totalPages) {
                    loadAccounts(jumpPage, perPage);
                } else {
                    alert(`页码必须在1到${totalPages}之间`);
                    jumpToPageInput.value = currentPage;
                }
            });
            
            refreshBtn.addEventListener('click', () => {
                loadAccounts(currentPage, perPage);
            });
            
            confirmDeleteBtn.addEventListener('click', handleConfirmDelete);
            
            // 初始加载账户列表
            loadAccounts();
        });
    </script>
{% endblock %}
